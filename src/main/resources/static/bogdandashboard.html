<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bogdan Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f4f9;
        }
        .container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 20px;
        }
        .table-container {
            overflow-x: auto;
            white-space: nowrap;
            max-height: 500px;
            overflow-y: auto;
        }
        table {
            min-width: 800px;
        }
        th {
            background: #007bff;
            color: white;
            text-align: center;
        }
        td {
            text-align: center;
        }
        td input {
            width: 100%;
            border: 1px solid #ddd;
            padding: 5px;
            box-sizing: border-box;
        }
        td input:focus {
            outline: none;
            border-color: #007bff;
        }
        /* Beautify Choose File and Center Save Changes */
        #excelFile {
            display: block;
            margin: 0 auto;
            max-width: 300px;
        }
        #saveChanges {
            display: block;
            margin: 20px auto;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Upload Bus Operation Data</h2>
    <div class="mb-3 text-center">
        <input type="file" id="excelFile" class="form-control" accept=".xlsx, .xls">
    </div>
    <div class="table-container">
        <table class="table table-bordered table-hover">
            <thead class="table-dark" id="table-head">
            <!-- Table Headers will be dynamically generated -->
            </thead>
            <tbody id="table-body">
            <!-- Table Rows will be dynamically generated -->
            </tbody>
        </table>
        <div class="text-center">
            <button class="btn btn-success mt-3" id="saveChanges" style="display: none;">Save Changes</button>
        </div>


        <!-- Bootstrap JS and Dependencies -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- SheetJS (xlsx) Library -->
        <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

        <!-- Custom Script -->
        <script>
            let excelData = [];

   document.getElementById('excelFile').addEventListener('change', function(event) {
       const file = event.target.files[0];
       if (file) {
           const reader = new FileReader();
           reader.onload = function(e) {
               const data = new Uint8Array(e.target.result);
               const workbook = XLSX.read(data, { type: 'array' });
               const sheetName = workbook.SheetNames[0];
               const sheet = workbook.Sheets[sheetName];
               excelData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

               // Clean and Format Data
               excelData = excelData.map(row =>
                   row.map(cell => (cell === undefined || cell === null) ? '' : String(cell).trim())
               );
               displayTable(excelData);
               document.getElementById('saveChanges').style.display = 'inline-block';
           };
           reader.readAsArrayBuffer(file);
       }
   });

  function displayTable(data) {
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');

    tableHead.innerHTML = '';
    tableBody.innerHTML = '';

    // Create Table Headers
    const headerRow = document.createElement('tr');
    data[0].forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    // Create Table Rows
    data.slice(1).forEach((rowData, rowIndex) => {
        const row = document.createElement('tr');

        // Ensure each row has the same number of columns as the header
        for (let colIndex = 0; colIndex < data[0].length; colIndex++) {
            const cell = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = rowData[colIndex] || '';

            // Disable input for Material Cost column (index 8)
            if (colIndex === 8) {
                input.setAttribute('disabled', 'disabled');
            } else {
                input.addEventListener('input', function() {
                    // Track changes in excelData array
                    excelData[rowIndex + 1][colIndex] = this.value;
                });
            }

            cell.appendChild(input);
            row.appendChild(cell);
        }

        tableBody.appendChild(row);
    });
}

// Save Changes to Database
document.getElementById('saveChanges').addEventListener('click', function() {
    // Collect updated data
    const updatedData = excelData.slice(1).map(row => {
        return {
            idTrim: row[0],              // Unique identifier
            make: row[1],
            model: row[2],
            series: row[3],
            classBus: row[4],
            appointment: row[5],
            totalSeats: row[6],
            doorWidth: row[7],
            engineType: row[9],
            numberOfCylinders: row[10],
            amountOfGear: row[11]
        };
    });

    // Send updated data to backend
    fetch('/updateBusData', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedData)
    })
    .then(response => {
        if (response.ok) {
            alert('Data updated successfully.');
        } else {
            alert('Error updating data.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating data.');
    });
});

        </script>
</body>
</html>
